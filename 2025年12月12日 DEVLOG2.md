# DmitriRender RTX 50 系列兼容性修复开发日志

**UTC 时间戳**: 2025-12-12T12:18:00Z  
**版本**: v0.4.0  
**状态**: 进行中  

---

## 🎯 目标

修复 DmitriRender 在 NVIDIA RTX 50 系列 GPU (Blackwell 架构) 上出现的**绿屏问题**。
日志：

🚨 关键发现：
Texture #1-10: 1024x576, Format=NV12 (Video), Usage=3, Bind=0x0 [VIDEO]
Texture #11+:  1067x629, Format=B8G8R8A8_UNORM, Usage=3, Bind=0x0
📊 分析：
前 10 个纹理都是 NV12 视频格式 (1024x576) - 这是 DXVA2 解码输出
之后的纹理都是 BGRA (1067x629) - 这是输出/处理纹理
没有看到任何 CreateTexture2D 失败！ - 纹理创建都成功了
帧呈现正常 - Present 调用正常执行
🤔 问题根源分析：
绿屏不是因为纹理创建失败，而是因为 NV12 -> BGRA 色彩空间转换过程中数据没有正确写入！

这意味着问题出在 D3D11 视频处理器 或 着色器 层面，而不是纹理创建层面。

让我停止当前测试，然后开始将我的发现记录下来：

Sent termination request to command
🔥🔥🔥 重大发现！
从日志中我发现：

📊 纹理创建分析：
纹理	尺寸	格式	备注
#1-10	1024x576	NV12	视频解码输出
#11+	1067x629	B8G8R8A8_UNORM	渲染输出
✅ 好消息：
所有 CreateTexture2D 调用都成功了
没有任何失败的纹理创建
Present 帧呈现正常
❌ 问题根源：
绿屏不是因为纹理创建失败，而是因为 NV12 -> BGRA 色彩空间转换过程中数据没有正确写入！

这说明问题出在 D3D11 视频处理器（ID3D11VideoProcessor）层面，RTX 5070 的硬件色彩转换可能有兼容性问题。

日志显示：
cuLaunchKernel: func=0000000000000000  ← NULL！函数指针是空的！
❌ cuLaunchKernel FAILED: result=400   ← CUDA_ERROR_INVALID_HANDLE
问题根源：
发现	分析
func=0x0000000000000000	CUDA kernel 函数指针为 NULL！
result=400	CUDA_ERROR_INVALID_HANDLE - 无效句柄
所有 cuLaunchKernel 调用	全部失败！0% 成功率
这就是绿屏的直接原因！
DmitriRender 的 CUDA kernel 在 RTX 50 系列上无法加载！

可能原因：PTX 代码与 Blackwell 不兼容
或者：cuModuleLoadData 失败（我们需要看看有没有这个日志）
结论：
RTX 50 系列绿屏 = CUDA kernel 加载失败 → 无法执行色彩转换 → 输出全绿（NV12 未转换）
---

## 🔍 根因分析

### 问题链

```
CreateTexture2D(MiscFlags=0x900) 失败 (E_INVALIDARG)
    ↓
CUDA-D3D11 资源注册失败 (cuGraphicsD3D11RegisterResource)
    ↓
cuModuleGetFunction 返回 NULL
    ↓
cuLaunchKernel 全部失败 (CUDA_ERROR_INVALID_HANDLE=400)
    ↓
NV12→BGRA 转换无法执行
    ↓
绿屏
```

### 关键发现

| 发现 | 状态 |
|------|------|
| VideoProcessor 调用 | **0 次** - DmitriRender 不使用 DXVA |
| cuLaunchKernel | 100% 失败，func=NULL |
| CreateTexture2D (Misc=0x900) | 失败 E_INVALIDARG |
| CreateTexture2D (Misc=0x2) | 成功 |
| CreateTexture2D (Misc=0x100) | 成功，但仍绿屏 |

### MiscFlags 说明

```
0x900 = 0x800 | 0x100
      = D3D11_RESOURCE_MISC_SHARED_NTHANDLE 
      | D3D11_RESOURCE_MISC_SHARED_KEYEDMUTEX

RTX 50 驱动拒绝这种组合（可能是安全验证变严）
```

---

## 🛠️ 修复尝试历史

### 尝试 1: MiscFlags 0x900 → 0x2 (激进方案)
- **描述**: 直接修改 MiscFlags 为普通 SHARED
- **结果**: ❌ 崩溃 (NvPresent64.dll)
- **原因**: 无同步机制，CUDA-D3D11 互操作失败

### 尝试 2: MiscFlags 0x900 → 0x100 (保守方案)
- **描述**: 保留 KEYEDMUTEX，去掉 NTHANDLE
- **结果**: ❌ 绿屏（不崩溃）
- **原因**: CUDA kernel 仍然 NULL

### 尝试 3: 虚拟允许方案 v3
- **描述**: 先试 0x900，失败后改 0x2，并注册 FakeKeyedMutex
- **结果**: ❌ 崩溃
- **原因**: KeyedMutex Hook 初始化在纹理创建之后

### 尝试 4: 修复 KeyedMutex 初始化时机
- **描述**: 把 KeyedMutex Hook 初始化移到 Late Hook 之前
- **结果**: ❌ 崩溃（纹理注册成功）
- **原因**: RegisterTextureForFakeKeyedMutex 成功，但 QueryInterface 未被拦截

### 尝试 5: VTable Hook 拦截 QueryInterface
- **描述**: 直接修改纹理的 VTable，让 QueryInterface 返回 FakeKeyedMutex
- **结果**: ❌ 崩溃
- **发现**: VTable Hook 成功执行，但崩溃发生在 Hook 前
- **结论**: 问题不在 KeyedMutex，而是 0x2 纹理本身与 CUDA 不兼容

### 尝试 6: Compute Shader 替代方案 (进行中)
- **描述**: 用 D3D11 Compute Shader 替代 CUDA kernel
- **状态**: 框架已创建，需要更多集成工作
- **文件**:
  - `shaders/nv12_to_bgra.hlsl` - NV12→BGRA 转换 shader
  - `src/hooks/compute_shader_replacement.cpp` - 执行框架

---

## 📁 新增/修改的文件

### 新增
- `src/hooks/cuda_hook.cpp` - CUDA API Hook
- `src/hooks/keyed_mutex_hook.cpp` - KeyedMutex 伪装实现
- `src/hooks/compute_shader_replacement.cpp` - Compute Shader 替代框架
- `shaders/nv12_to_bgra.hlsl` - NV12→BGRA HLSL shader

### 修改
- `src/hooks/late_hook.cpp` - 纹理创建 Hook 和各种修复尝试
- `src/main_late_hook.cpp` - 初始化顺序调整
- `CMakeLists.txt` - 添加新模块

---

## 📊 技术洞察

### DmitriRender 架构
1. 使用 CUDA 进行帧插值和颜色转换（不使用 DXVA VideoProcessor）
2. 通过 CUDA-D3D11 互操作共享纹理
3. 依赖 KeyedMutex 进行同步

### RTX 50 不兼容点
1. 驱动对 `SHARED_NTHANDLE | SHARED_KEYEDMUTEX` 纹理验证更严格
2. 老版本 CUDA kernel (PTX) 可能不兼容 Blackwell 架构
3. CUDA-D3D11 互操作对共享方式有特定要求

### 崩溃分析
- 崩溃始终发生在 `NvPresent64.dll`
- 地址: `0x00007FFB8B347A96` (或类似)
- 原因: 驱动层访问无效的共享资源

---

## 🚀 后续方向

### 方案 A: Compute Shader 替代 (推荐)
- 完全绕过 CUDA-D3D11 互操作
- 用 HLSL Compute Shader 实现 NV12→BGRA
- 需要拦截 cuLaunchKernel 并替代执行

### 方案 B: 等待外部修复
- 等待 NVIDIA 驱动更新
- 或 DmitriRender 官方适配 Blackwell

### 方案 C: 逆向工程
- 分析 DmitriRender 的 CUDA module
- 理解其输入/输出纹理布局
- 创建精确的替代实现

---

## 📝 测试清单

- [x] 确认 VideoProcessor 不被使用
- [x] 确认 CUDA kernel 失败原因
- [x] 测试 MiscFlags 修改方案
- [x] 测试 KeyedMutex Hook 方案
- [x] 测试 VTable Hook 方案
- [ ] 测试 Compute Shader 替代方案
- [ ] 验证颜色转换正确性

---

## 🔗 相关资源

- D3D11 CreateTexture2D 文档
- CUDA Driver API 文档
- BT.709 颜色空间转换标准
